@inherits LayoutComponentBase
@inject VFSStateService StateService
@inject UndoRedoService UndoRedoService
@inject IJSRuntime JS
@implements IDisposable

<div class="h-screen flex flex-col bg-gray-50">
    @* Top Bar *@
    <TopBar OnToggleSidebar="ToggleSidebar" OnToggleHistory="ToggleHistory" OnToggleGitHubImport="ToggleGitHubImport" OnToggleGitHubSettings="ToggleGitHubSettings" />

    @* Main Content Area *@
    <div class="flex-1 flex overflow-hidden">
        @* Left Sidebar (hidden on mobile by default) *@
        <div class="hidden lg:block">
            <LeftSidebar IsOpen="true" />
        </div>

        @* Main Content *@
        <main class="flex-1 overflow-auto">
            @Body
        </main>

        @* Right Preview Panel *@
        @if (StateService.ShowPreviewPanel)
        {
            <aside class="w-preview bg-white border-l border-gray-200 hidden lg:block overflow-y-auto">
                <FilePreviewPanel />
            </aside>
        }
    </div>

    @* Toast Notifications *@
    <ToastContainer />
</div>

@* History Drawer *@
@if (_showHistory)
{
    <HistoryDrawer OnClose="() => _showHistory = false" />
}

@* GitHub Import Dialog *@
<GitHubImportDialog @bind-IsOpen="_showGitHubImport" OnOpenGitHubSettings="() => _showGitHubSettings = true" />

@* GitHub Settings Dialog *@
<GitHubSettingsDialog @bind-IsOpen="_showGitHubSettings" />

@* Mobile Sidebar Overlay *@
@if (_sidebarOpen)
{
    <div class="fixed inset-0 z-40 lg:hidden">
        <div class="fixed inset-0 bg-black/50" @onclick="() => _sidebarOpen = false"></div>
        <div class="fixed inset-y-0 left-0 w-sidebar z-50 animate-slide-in">
            <LeftSidebar IsOpen="true" OnClose="() => _sidebarOpen = false" />
        </div>
    </div>
}

<div id="blazor-error-ui" data-nosnippet>
  An unhandled error has occurred.
  <a href="." class="reload">Reload</a>
  <span class="dismiss">X</span>
</div>

@code {
    private bool _sidebarOpen = false;
    private bool _showHistory = false;
    private bool _showGitHubImport = false;
    private bool _showGitHubSettings = false;
    private DotNetObjectReference<MainLayout>? _jsRef;

    protected override void OnInitialized()
    {
        StateService.OnStateChanged += StateHasChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _jsRef = DotNetObjectReference.Create(this);
            await JS.InvokeVoidAsync("cloudDrive.keyboard.registerUndoRedo", _jsRef);
        }
    }

    private void ToggleSidebar()
    {
        _sidebarOpen = !_sidebarOpen;
    }

    private void ToggleHistory()
    {
        _showHistory = !_showHistory;
    }

    private void ToggleGitHubImport()
    {
        _showGitHubImport = !_showGitHubImport;
    }

    private void ToggleGitHubSettings()
    {
        _showGitHubSettings = !_showGitHubSettings;
    }

    [JSInvokable]
    public void HandleUndo()
    {
        UndoRedoService.Undo();
        InvokeAsync(StateHasChanged);
    }

    [JSInvokable]
    public void HandleRedo()
    {
        UndoRedoService.Redo();
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        StateService.OnStateChanged -= StateHasChanged;
        _jsRef?.Dispose();
    }
}
