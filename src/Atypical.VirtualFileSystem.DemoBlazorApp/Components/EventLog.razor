@inject IVirtualFileSystem VFS
@rendermode InteractiveServer

<MudStack Spacing="2">
    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
        <MudText Typo="Typo.body2">
            Events: @EventHistory.Count
        </MudText>
        <MudButton StartIcon="Icons.Material.Filled.Clear" 
                   Size="Size.Small" 
                   Variant="Variant.Text"
                   OnClick="ClearLog"
                   Disabled="!EventHistory.Any()">
            Clear
        </MudButton>
    </MudStack>

    @if (!EventHistory.Any())
    {
        <MudAlert Severity="Severity.Info" Icon="Icons.Material.Filled.Info" Dense="true">
            No events yet. Perform some file operations to see events here.
        </MudAlert>
    }
    else
    {
        <MudPaper Class="pa-2" Elevation="1" Style="max-height: 300px; overflow-y: auto;">
            @foreach (var eventEntry in EventHistory.AsEnumerable().Reverse().Take(20))
            {
                <MudCard Class="mb-2" Elevation="0">
                    <MudCardContent Class="pa-2">
                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                            <MudStack Spacing="0">
                                <MudText Typo="Typo.caption" Class="text-muted">
                                    @eventEntry.Timestamp.ToString("HH:mm:ss.fff")
                                </MudText>
                                <MudText Typo="Typo.body2">
                                    @eventEntry.Event.Message
                                </MudText>
                            </MudStack>
                            <MudChip T="string" Size="Size.Small" 
                                     Color="@GetEventColor(eventEntry.Event)" 
                                     Variant="Variant.Text">
                                @GetEventType(eventEntry.Event)
                            </MudChip>
                        </MudStack>
                    </MudCardContent>
                </MudCard>
            }
        </MudPaper>
        
        @if (EventHistory.Count > 20)
        {
            <MudText Typo="Typo.caption" Class="text-muted">
                Showing last 20 of @EventHistory.Count events
            </MudText>
        }
    }
</MudStack>

@code {
    private List<EventEntry> EventHistory = new();

    protected override void OnInitialized()
    {
        // Subscribe to all VFS events
        VFS.FileCreated += OnFileCreated;
        VFS.FileDeleted += OnFileDeleted;
        VFS.FileMoved += OnFileMoved;
        VFS.FileRenamed += OnFileRenamed;
        VFS.DirectoryCreated += OnDirectoryCreated;
        VFS.DirectoryDeleted += OnDirectoryDeleted;
        VFS.DirectoryMoved += OnDirectoryMoved;
        VFS.DirectoryRenamed += OnDirectoryRenamed;
    }

    private void OnFileCreated(VFSFileCreatedArgs e) => AddEvent(e);
    private void OnFileDeleted(VFSFileDeletedArgs e) => AddEvent(e);
    private void OnFileMoved(VFSFileMovedArgs e) => AddEvent(e);
    private void OnFileRenamed(VFSFileRenamedArgs e) => AddEvent(e);
    private void OnDirectoryCreated(VFSDirectoryCreatedArgs e) => AddEvent(e);
    private void OnDirectoryDeleted(VFSDirectoryDeletedArgs e) => AddEvent(e);
    private void OnDirectoryMoved(VFSDirectoryMovedArgs e) => AddEvent(e);
    private void OnDirectoryRenamed(VFSDirectoryRenamedArgs e) => AddEvent(e);

    private void AddEvent(VFSEventArgs eventArgs)
    {
        EventHistory.Add(new EventEntry
        {
            Event = eventArgs,
            Timestamp = DateTime.Now
        });
        
        InvokeAsync(StateHasChanged);
    }

    private void ClearLog()
    {
        EventHistory.Clear();
        StateHasChanged();
    }

    private Color GetEventColor(VFSEventArgs eventArgs)
    {
        return eventArgs switch
        {
            VFSFileCreatedArgs or VFSDirectoryCreatedArgs => Color.Success,
            VFSFileDeletedArgs or VFSDirectoryDeletedArgs => Color.Error,
            VFSFileMovedArgs or VFSDirectoryMovedArgs => Color.Info,
            VFSFileRenamedArgs or VFSDirectoryRenamedArgs => Color.Warning,
            _ => Color.Default
        };
    }

    private string GetEventType(VFSEventArgs eventArgs)
    {
        return eventArgs switch
        {
            VFSFileCreatedArgs => "File+",
            VFSFileDeletedArgs => "File-",
            VFSFileMovedArgs => "File→",
            VFSFileRenamedArgs => "File↻",
            VFSDirectoryCreatedArgs => "Dir+",
            VFSDirectoryDeletedArgs => "Dir-",
            VFSDirectoryMovedArgs => "Dir→",
            VFSDirectoryRenamedArgs => "Dir↻",
            _ => "Unknown"
        };
    }

    private record EventEntry
    {
        public required VFSEventArgs Event { get; init; }
        public required DateTime Timestamp { get; init; }
    }

    public void Dispose()
    {
        // Unsubscribe from events
        VFS.FileCreated -= OnFileCreated;
        VFS.FileDeleted -= OnFileDeleted;
        VFS.FileMoved -= OnFileMoved;
        VFS.FileRenamed -= OnFileRenamed;
        VFS.DirectoryCreated -= OnDirectoryCreated;
        VFS.DirectoryDeleted -= OnDirectoryDeleted;
        VFS.DirectoryMoved -= OnDirectoryMoved;
        VFS.DirectoryRenamed -= OnDirectoryRenamed;
    }
}