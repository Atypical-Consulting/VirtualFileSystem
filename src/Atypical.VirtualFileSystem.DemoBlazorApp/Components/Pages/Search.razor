@page "/search"
@inject IVirtualFileSystem VFS
@inject Services.VFSStateService StateService
@rendermode InteractiveServer

<PageTitle>Search - VFS Demo</PageTitle>

<MudText Typo="Typo.h4" GutterBottom="true">Search Files & Directories</MudText>
<MudText Typo="Typo.subtitle1" Class="mb-4">Find files and directories using various search criteria</MudText>

<MudGrid>
    <MudItem xs="12" lg="4">
        <MudPaper Class="pa-4" Elevation="2">
            <MudText Typo="Typo.h6" Class="mb-3">
                <MudIcon Icon="@Icons.Material.Filled.Search" Class="mr-2" />
                Search Criteria
            </MudText>
            
            <MudStack Spacing="3">
                <MudTextField @bind-Value="SearchTerm" 
                              Label="Search Term" 
                              Placeholder="Enter filename or pattern"
                              FullWidth="true"
                              @onkeyup="OnSearchKeyUp"
                              Adornment="Adornment.End"
                              AdornmentIcon="@Icons.Material.Filled.Search" />
                
                <MudSelect @bind-Value="SearchType" Label="Search Type" FullWidth="true">
                    <MudSelectItem Value="SearchTypes.Name">Name Contains</MudSelectItem>
                    <MudSelectItem Value="SearchTypes.Exact">Exact Name</MudSelectItem>
                    <MudSelectItem Value="SearchTypes.Extension">File Extension</MudSelectItem>
                    <MudSelectItem Value="SearchTypes.Content">Content Contains</MudSelectItem>
                    <MudSelectItem Value="SearchTypes.Regex">Regex Pattern</MudSelectItem>
                </MudSelect>
                
                <MudSelect @bind-Value="SearchTarget" Label="Search Target" FullWidth="true">
                    <MudSelectItem Value="SearchTargets.Both">Files & Directories</MudSelectItem>
                    <MudSelectItem Value="SearchTargets.FilesOnly">Files Only</MudSelectItem>
                    <MudSelectItem Value="SearchTargets.DirectoriesOnly">Directories Only</MudSelectItem>
                </MudSelect>
                
                <MudCheckBox @bind-Value="CaseSensitive" Label="Case Sensitive" />
                
                <MudStack Row="true" Spacing="2">
                    <MudButton Variant="Variant.Filled" 
                               Color="Color.Primary"
                               StartIcon="@Icons.Material.Filled.Search"
                               OnClick="PerformSearch"
                               Disabled="string.IsNullOrWhiteSpace(SearchTerm)">
                        Search
                    </MudButton>
                    <MudButton Variant="Variant.Outlined" 
                               StartIcon="@Icons.Material.Filled.Clear"
                               OnClick="ClearSearch">
                        Clear
                    </MudButton>
                </MudStack>
            </MudStack>
        </MudPaper>
    </MudItem>
    
    <MudItem xs="12" lg="8">
        <MudPaper Class="pa-4" Elevation="2">
            <MudText Typo="Typo.h6" Class="mb-3">
                <MudIcon Icon="@Icons.Material.Filled.FindInPage" Class="mr-2" />
                Search Results (@SearchResults.Count)
            </MudText>
            
            @if (IsSearching)
            {
                <div class="text-center pa-4">
                    <MudProgressCircular Indeterminate="true" />
                    <MudText Typo="Typo.body2" Class="mt-2">Searching...</MudText>
                </div>
            }
            else if (!SearchResults.Any() && HasSearched)
            {
                <MudAlert Severity="Severity.Info" Icon="@Icons.Material.Filled.Info">
                    No results found for "@SearchTerm"
                </MudAlert>
            }
            else if (SearchResults.Any())
            {
                <div style="max-height: 500px; overflow-y: auto;">
                    @foreach (var result in SearchResults)
                    {
                        <MudCard Class="mb-2" Elevation="1">
                            <MudCardContent Class="pa-3">
                                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                    <MudStack Spacing="1">
                                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                            <MudIcon Icon="@GetNodeIcon(result)" />
                                            <MudText Typo="Typo.h6">@result.Name</MudText>
                                            <MudChip T="string" Size="Size.Small" 
                                                     Color="@(result.IsDirectory ? Color.Primary : Color.Secondary)">
                                                @(result.IsDirectory ? "Directory" : "File")
                                            </MudChip>
                                        </MudStack>
                                        <MudText Typo="Typo.caption" Class="text-muted">
                                            @result.Path.Value
                                        </MudText>
                                        @if (result is IFileNode file && SearchType == SearchTypes.Content && !string.IsNullOrEmpty(SearchTerm))
                                        {
                                            <MudText Typo="Typo.caption" Class="text-muted">
                                                Size: @file.Content.Length bytes
                                            </MudText>
                                        }
                                    </MudStack>
                                    <MudStack Row="true" Spacing="1">
                                        <MudButton Variant="Variant.Text" 
                                                   Size="Size.Small"
                                                   StartIcon="@Icons.Material.Filled.Visibility"
                                                   OnClick="() => SelectNode(result)">
                                            Select
                                        </MudButton>
                                        @if (result is IFileNode)
                                        {
                                            <MudButton Variant="Variant.Text" 
                                                       Size="Size.Small"
                                                       StartIcon="@Icons.Material.Filled.Edit"
                                                       Href="@($"/editor?file={Uri.EscapeDataString(result.Path.Value)}")">
                                                Edit
                                            </MudButton>
                                        }
                                    </MudStack>
                                </MudStack>
                            </MudCardContent>
                        </MudCard>
                    }
                </div>
            }
            else
            {
                <MudAlert Severity="Severity.Normal" Icon="@Icons.Material.Filled.Search">
                    Enter search criteria and click "Search" to find files and directories.
                </MudAlert>
            }
        </MudPaper>
    </MudItem>
</MudGrid>

@code {
    private string SearchTerm = "";
    private SearchTypes SearchType = SearchTypes.Name;
    private SearchTargets SearchTarget = SearchTargets.Both;
    private bool CaseSensitive = false;
    private bool IsSearching = false;
    private bool HasSearched = false;
    
    private List<IVirtualFileSystemNode> SearchResults = new();

    private enum SearchTypes
    {
        Name, Exact, Extension, Content, Regex
    }
    
    private enum SearchTargets
    {
        Both, FilesOnly, DirectoriesOnly
    }

    private async Task OnSearchKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(SearchTerm))
        {
            await PerformSearch();
        }
    }

    private async Task PerformSearch()
    {
        if (string.IsNullOrWhiteSpace(SearchTerm))
            return;

        IsSearching = true;
        HasSearched = true;
        SearchResults.Clear();
        StateHasChanged();

        try
        {
            // Simulate search delay for better UX
            await Task.Delay(100);

            var allNodes = new List<IVirtualFileSystemNode>();
            
            // Add files and directories based on search target
            if (SearchTarget is SearchTargets.Both or SearchTargets.FilesOnly)
            {
                allNodes.AddRange(VFS.Files);
            }
            
            if (SearchTarget is SearchTargets.Both or SearchTargets.DirectoriesOnly)
            {
                allNodes.AddRange(VFS.Directories);
            }

            // Apply search criteria
            foreach (var node in allNodes)
            {
                if (MatchesSearchCriteria(node))
                {
                    SearchResults.Add(node);
                }
            }

            // Sort results: directories first, then files, both alphabetically
            SearchResults = SearchResults
                .OrderBy(n => n.IsFile ? 1 : 0)
                .ThenBy(n => n.Name, CaseSensitive ? StringComparer.Ordinal : StringComparer.OrdinalIgnoreCase)
                .ToList();
        }
        catch (Exception)
        {
            // Handle search errors silently for now
        }
        finally
        {
            IsSearching = false;
            StateHasChanged();
        }
    }

    private bool MatchesSearchCriteria(IVirtualFileSystemNode node)
    {
        var comparison = CaseSensitive ? StringComparison.Ordinal : StringComparison.OrdinalIgnoreCase;
        
        return SearchType switch
        {
            SearchTypes.Name => node.Name.Contains(SearchTerm, comparison),
            SearchTypes.Exact => node.Name.Equals(SearchTerm, comparison),
            SearchTypes.Extension => node is IFileNode && 
                                   Path.GetExtension(node.Name).Equals(SearchTerm.StartsWith('.') ? SearchTerm : '.' + SearchTerm, comparison),
            SearchTypes.Content => node is IFileNode file && 
                                 file.Content.Contains(SearchTerm, comparison),
            SearchTypes.Regex => IsRegexMatch(node.Name, SearchTerm),
            _ => false
        };
    }

    private bool IsRegexMatch(string input, string pattern)
    {
        try
        {
            var options = CaseSensitive ? RegexOptions.None : RegexOptions.IgnoreCase;
            return Regex.IsMatch(input, pattern, options);
        }
        catch
        {
            return false;
        }
    }

    private void ClearSearch()
    {
        SearchTerm = "";
        SearchResults.Clear();
        HasSearched = false;
        StateHasChanged();
    }

    private void SelectNode(IVirtualFileSystemNode node)
    {
        StateService.SelectedNode = node;
    }

    private string GetNodeIcon(IVirtualFileSystemNode node)
    {
        return node.IsDirectory ? Icons.Material.Filled.Folder : Icons.Material.Filled.InsertDriveFile;
    }
}