@page "/bin"
@inject RecycleBinService RecycleBinService
@inject IVirtualFileSystem VFS
@inject ToastService Toast
@rendermode InteractiveServer
@implements IDisposable

<PageTitle>Recycle Bin - CloudDrive</PageTitle>

<div class="h-full flex flex-col bg-white">
    @* Header *@
    <div class="p-4 border-b border-gray-200">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
                <svg class="w-6 h-6 text-gray-500" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
                </svg>
                <h1 class="text-xl font-semibold text-gray-900">Recycle Bin</h1>
            </div>
            @if (RecycleBinService.DeletedItems.Any())
            {
                <Button Variant="danger" Size="sm" OnClick="EmptyBin"
                        Icon="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0">
                    Empty Bin
                </Button>
            }
        </div>
        <p class="text-sm text-gray-500 mt-1">Deleted items are kept here until you empty the bin</p>
    </div>

    @* Content *@
    <div class="flex-1 overflow-auto">
        @if (!RecycleBinService.DeletedItems.Any())
        {
            <EmptyState Title="Recycle bin is empty"
                        Description="Deleted files and folders will appear here"
                        Icon="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
        }
        else
        {
            <div class="divide-y divide-gray-100">
                @foreach (var item in RecycleBinService.DeletedItems)
                {
                    <div class="flex items-center gap-4 px-4 py-3 hover:bg-gray-50 transition-colors">
                        <FileIcon IsDirectory="@item.IsDirectory" FileName="@item.Name" />
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-gray-900 truncate">@item.Name</p>
                            <p class="text-xs text-gray-500 truncate">@item.OriginalPath</p>
                        </div>
                        <div class="text-right text-xs text-gray-500">
                            Deleted @GetTimeAgo(item.DeletedAt)
                        </div>
                        <div class="flex items-center gap-1">
                            <button class="btn btn-ghost text-sm px-3 py-1"
                                    @onclick="() => RestoreItem(item.Id)"
                                    title="Restore">
                                <svg class="w-4 h-4 mr-1" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 15 3 9m0 0 6-6M3 9h12a6 6 0 0 1 0 12h-3" />
                                </svg>
                                Restore
                            </button>
                            <button class="p-1.5 text-red-500 hover:text-red-700 rounded-md hover:bg-red-50"
                                    @onclick="() => PermanentlyDelete(item.Id)"
                                    title="Delete permanently">
                                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                    </div>
                }
            </div>
        }
    </div>
</div>

@code {
    protected override void OnInitialized()
    {
        RecycleBinService.OnChange += StateHasChanged;
    }

    private void RestoreItem(Guid itemId)
    {
        if (RecycleBinService.Restore(VFS, itemId))
        {
            Toast.ShowSuccess("Item restored successfully");
        }
        else
        {
            Toast.ShowError("Failed to restore item");
        }
    }

    private void PermanentlyDelete(Guid itemId)
    {
        RecycleBinService.PermanentlyDelete(itemId);
        Toast.ShowSuccess("Item permanently deleted");
    }

    private void EmptyBin()
    {
        RecycleBinService.EmptyRecycleBin();
        Toast.ShowSuccess("Recycle bin emptied");
    }

    private string GetTimeAgo(DateTime time)
    {
        var diff = DateTime.Now - time;

        if (diff.TotalMinutes < 1) return "just now";
        if (diff.TotalMinutes < 60) return $"{(int)diff.TotalMinutes}m ago";
        if (diff.TotalHours < 24) return $"{(int)diff.TotalHours}h ago";
        if (diff.TotalDays < 7) return $"{(int)diff.TotalDays}d ago";

        return time.ToString("MMM d");
    }

    public void Dispose()
    {
        RecycleBinService.OnChange -= StateHasChanged;
    }
}
