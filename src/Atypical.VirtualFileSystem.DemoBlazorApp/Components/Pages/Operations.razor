@page "/operations"
@inject IVirtualFileSystem VFS
@inject Services.VFSStateService StateService
@rendermode InteractiveServer

<PageTitle>File Operations - VFS Demo</PageTitle>

<MudText Typo="Typo.h4" GutterBottom="true">File Operations</MudText>
<MudText Typo="Typo.subtitle1" Class="mb-4">Create, manage, and manipulate files and directories</MudText>

<MudGrid>
    <MudItem xs="12" lg="8">
        <MudPaper Class="pa-4" Elevation="2" Style="height: 600px;">
            <MudText Typo="Typo.h6" Class="mb-3">
                <MudIcon Icon="@Icons.Material.Filled.AccountTree" Class="mr-2" />
                File Explorer
            </MudText>
            <div style="height: 520px; overflow-y: auto;">
                <FileExplorer @ref="FileExplorerRef" OnNodeSelected="OnNodeSelected" />
            </div>
        </MudPaper>
    </MudItem>
    
    <MudItem xs="12" lg="4">
        <MudStack Spacing="3">
            <MudPaper Class="pa-4" Elevation="2">
                <MudText Typo="Typo.h6" Class="mb-3">
                    <MudIcon Icon="@Icons.Material.Filled.Build" Class="mr-2" />
                    Operations Panel
                </MudText>
                <FileOperations OnOperationCompleted="OnOperationCompleted" />
            </MudPaper>
            
            <MudPaper Class="pa-4" Elevation="2">
                <MudText Typo="Typo.h6" Class="mb-3">
                    <MudIcon Icon="@Icons.Material.Filled.History" Class="mr-2" />
                    Undo/Redo
                </MudText>
                <UndoRedoControls OnHistoryChanged="OnOperationCompleted" />
            </MudPaper>
        </MudStack>
    </MudItem>
</MudGrid>

@if (StateService.SelectedNode != null)
{
    <MudPaper Class="pa-4 mt-4" Elevation="2">
        <MudText Typo="Typo.h6" Class="mb-3">
            <MudIcon Icon="@GetNodeIcon(StateService.SelectedNode)" Class="mr-2" />
            Selected: @StateService.SelectedNode.Name
        </MudText>
        
        <MudGrid>
            <MudItem xs="12" md="6">
                <MudSimpleTable Dense="true">
                    <tbody>
                        <tr>
                            <td><strong>Type:</strong></td>
                            <td>@(StateService.SelectedNode.IsDirectory ? "Directory" : "File")</td>
                        </tr>
                        <tr>
                            <td><strong>Path:</strong></td>
                            <td><MudText Typo="Typo.caption">@StateService.SelectedNode.Path.Value</MudText></td>
                        </tr>
                        <tr>
                            <td><strong>Created:</strong></td>
                            <td>@StateService.SelectedNode.CreationTime.ToString("yyyy-MM-dd HH:mm:ss")</td>
                        </tr>
                        <tr>
                            <td><strong>Modified:</strong></td>
                            <td>@StateService.SelectedNode.LastWriteTime.ToString("yyyy-MM-dd HH:mm:ss")</td>
                        </tr>
                        @if (StateService.SelectedNode is IFileNode fileNode)
                        {
                            <tr>
                                <td><strong>Size:</strong></td>
                                <td>@fileNode.Content.Length bytes</td>
                            </tr>
                        }
                    </tbody>
                </MudSimpleTable>
            </MudItem>
            
            @if (StateService.SelectedNode is IFileNode selectedFile)
            {
                <MudItem xs="12" md="6">
                    <MudButton Variant="Variant.Filled" 
                               Color="Color.Primary"
                               StartIcon="@Icons.Material.Filled.Edit"
                               Href="@($"/editor?file={Uri.EscapeDataString(selectedFile.Path.Value)}")"
                               FullWidth="true">
                        Edit File Content
                    </MudButton>
                </MudItem>
            }
        </MudGrid>
    </MudPaper>
}

@code {
    private FileExplorer? FileExplorerRef;

    protected override void OnInitialized()
    {
        StateService.OnDataChanged += StateHasChanged;
    }

    private async Task OnOperationCompleted()
    {
        if (FileExplorerRef != null)
        {
            await FileExplorerRef.RefreshTree();
        }
        StateService.NotifyDataChanged();
        StateHasChanged();
    }

    private void OnNodeSelected(IVirtualFileSystemNode node)
    {
        StateService.SelectedNode = node;
        StateHasChanged();
    }

    private string GetNodeIcon(IVirtualFileSystemNode node)
    {
        return node.IsDirectory ? Icons.Material.Filled.Folder : Icons.Material.Filled.InsertDriveFile;
    }

    public void Dispose()
    {
        StateService.OnDataChanged -= StateHasChanged;
    }
}