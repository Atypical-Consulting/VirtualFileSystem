@page "/analytics"
@inject IVirtualFileSystem VFS
@inject Services.VFSStateService StateService
@rendermode InteractiveServer

<PageTitle>Analytics - VFS Demo</PageTitle>

<MudText Typo="Typo.h4" GutterBottom="true">VFS Analytics</MudText>
<MudText Typo="Typo.subtitle1" Class="mb-4">Comprehensive analysis and insights into your virtual file system</MudText>

<MudGrid>
    <!-- File System Overview -->
    <MudItem xs="12" lg="6">
        <MudPaper Class="pa-4" Elevation="2">
            <MudText Typo="Typo.h6" Class="mb-3">
                <MudIcon Icon="@Icons.Material.Filled.Assessment" Class="mr-2" />
                File System Overview
            </MudText>
            
            @if (!VFS.IsEmpty)
            {
                <MudGrid>
                    <MudItem xs="6">
                        <MudCard Elevation="1">
                            <MudCardContent Class="text-center">
                                <MudText Typo="Typo.h4" Color="Color.Primary">@VFS.Index.FilesCount</MudText>
                                <MudText Typo="Typo.body2">Total Files</MudText>
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                    <MudItem xs="6">
                        <MudCard Elevation="1">
                            <MudCardContent Class="text-center">
                                <MudText Typo="Typo.h4" Color="Color.Secondary">@VFS.Index.DirectoriesCount</MudText>
                                <MudText Typo="Typo.body2">Total Directories</MudText>
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                    <MudItem xs="6">
                        <MudCard Elevation="1">
                            <MudCardContent Class="text-center">
                                <MudText Typo="Typo.h4" Color="Color.Info">@GetTotalContentSize()</MudText>
                                <MudText Typo="Typo.body2">Total Size (bytes)</MudText>
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                    <MudItem xs="6">
                        <MudCard Elevation="1">
                            <MudCardContent Class="text-center">
                                <MudText Typo="Typo.h4" Color="Color.Success">@GetMaxDepth()</MudText>
                                <MudText Typo="Typo.body2">Max Depth</MudText>
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                </MudGrid>
            }
            else
            {
                <MudAlert Severity="Severity.Info" Icon="@Icons.Material.Filled.Info">
                    No files or directories to analyze.
                </MudAlert>
            }
        </MudPaper>
    </MudItem>
    
    <!-- File Types Distribution -->
    <MudItem xs="12" lg="6">
        <MudPaper Class="pa-4" Elevation="2">
            <MudText Typo="Typo.h6" Class="mb-3">
                <MudIcon Icon="@Icons.Material.Filled.PieChart" Class="mr-2" />
                File Types Distribution
            </MudText>
            
            @if (GetFileExtensions().Any())
            {
                <MudSimpleTable Dense="true">
                    <thead>
                        <tr>
                            <th>Extension</th>
                            <th>Count</th>
                            <th>Size (bytes)</th>
                            <th>Percentage</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var group in GetFileExtensions().Take(10))
                        {
                            var extension = group.Key;
                            var files = group.AsEnumerable();
                            var percentage = (double)files.Count() / VFS.Index.FilesCount * 100;
                            <tr>
                                <td>
                                    <MudChip T="string" Size="Size.Small" Variant="Variant.Text">
                                        @(string.IsNullOrEmpty(extension) ? "(no ext)" : extension)
                                    </MudChip>
                                </td>
                                <td>@files.Count()</td>
                                <td>@files.Sum(f => f.Content.Length)</td>
                                <td>
                                    <MudProgressLinear Value="@percentage" 
                                                       Color="Color.Primary" 
                                                       Size="Size.Small" 
                                                       Class="my-1" />
                                    @percentage.ToString("F1")%
                                </td>
                            </tr>
                        }
                    </tbody>
                </MudSimpleTable>
            }
            else
            {
                <MudAlert Severity="Severity.Info" Icon="@Icons.Material.Filled.Info">
                    No files to analyze for type distribution.
                </MudAlert>
            }
        </MudPaper>
    </MudItem>
    
    <!-- Directory Structure Analysis -->
    <MudItem xs="12" lg="6">
        <MudPaper Class="pa-4" Elevation="2">
            <MudText Typo="Typo.h6" Class="mb-3">
                <MudIcon Icon="@Icons.Material.Filled.AccountTree" Class="mr-2" />
                Directory Structure
            </MudText>
            
            @if (VFS.Directories.Any())
            {
                <MudSimpleTable Dense="true">
                    <thead>
                        <tr>
                            <th>Directory</th>
                            <th>Depth</th>
                            <th>Files</th>
                            <th>Subdirs</th>
                            <th>Total Size</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var dir in VFS.Directories.OrderBy(d => d.Path.Depth).ThenBy(d => d.Name).Take(10))
                        {
                            <tr>
                                <td>
                                    <MudButton Variant="Variant.Text" 
                                               Size="Size.Small"
                                               StartIcon="@Icons.Material.Filled.Folder"
                                               OnClick="() => SelectDirectory(dir)">
                                        @(dir.Path.IsRoot ? "/" : dir.Name)
                                    </MudButton>
                                </td>
                                <td>@dir.Path.Depth</td>
                                <td>@dir.Files.Count()</td>
                                <td>@dir.Directories.Count()</td>
                                <td>@GetDirectorySize(dir) bytes</td>
                            </tr>
                        }
                    </tbody>
                </MudSimpleTable>
            }
            else
            {
                <MudAlert Severity="Severity.Info" Icon="@Icons.Material.Filled.Info">
                    No directories to analyze.
                </MudAlert>
            }
        </MudPaper>
    </MudItem>
    
    <!-- Largest Files -->
    <MudItem xs="12" lg="6">
        <MudPaper Class="pa-4" Elevation="2">
            <MudText Typo="Typo.h6" Class="mb-3">
                <MudIcon Icon="@Icons.Material.Filled.Storage" Class="mr-2" />
                Largest Files
            </MudText>
            
            @if (VFS.Files.Any())
            {
                <MudSimpleTable Dense="true">
                    <thead>
                        <tr>
                            <th>File</th>
                            <th>Size (bytes)</th>
                            <th>Lines</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var file in VFS.Files.OrderByDescending(f => f.Content.Length).Take(10))
                        {
                            <tr>
                                <td>
                                    <MudButton Variant="Variant.Text" 
                                               Size="Size.Small"
                                               StartIcon="@Icons.Material.Filled.InsertDriveFile"
                                               OnClick="() => SelectFile(file)">
                                        @file.Name
                                    </MudButton>
                                </td>
                                <td>@file.Content.Length</td>
                                <td>@file.Content.Split('\n').Length</td>
                                <td>
                                    <MudButton Variant="Variant.Text" 
                                               Size="Size.Small"
                                               StartIcon="@Icons.Material.Filled.Edit"
                                               Href="@($"/editor?file={Uri.EscapeDataString(file.Path.Value)}")">
                                        Edit
                                    </MudButton>
                                </td>
                            </tr>
                        }
                    </tbody>
                </MudSimpleTable>
            }
            else
            {
                <MudAlert Severity="Severity.Info" Icon="@Icons.Material.Filled.Info">
                    No files to analyze for size comparison.
                </MudAlert>
            }
        </MudPaper>
    </MudItem>
</MudGrid>

<!-- Search Suggestions -->
<MudPaper Class="pa-4 mt-4" Elevation="2">
    <MudText Typo="Typo.h6" Class="mb-3">
        <MudIcon Icon="@Icons.Material.Filled.Lightbulb" Class="mr-2" />
        Quick Analysis Actions
    </MudText>
    
    <MudGrid>
        <MudItem xs="12" sm="6" md="3">
            <MudButton Variant="Variant.Outlined" 
                       FullWidth="true"
                       StartIcon="@Icons.Material.Filled.Search"
                       Href="/search">
                Search Files
            </MudButton>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudButton Variant="Variant.Outlined" 
                       FullWidth="true"
                       StartIcon="@Icons.Material.Filled.CreateNewFolder"
                       Href="/operations">
                Manage Files
            </MudButton>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudButton Variant="Variant.Outlined" 
                       FullWidth="true"
                       StartIcon="@Icons.Material.Filled.History"
                       Href="/history">
                View History
            </MudButton>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudButton Variant="Variant.Outlined" 
                       FullWidth="true"
                       StartIcon="@Icons.Material.Filled.Refresh"
                       OnClick="RefreshAnalytics">
                Refresh Data
            </MudButton>
        </MudItem>
    </MudGrid>
</MudPaper>

@code {
    protected override void OnInitialized()
    {
        StateService.OnDataChanged += StateHasChanged;
    }

    private long GetTotalContentSize()
    {
        return VFS.Files.Sum(f => (long)f.Content.Length);
    }

    private int GetMaxDepth()
    {
        if (!VFS.Index.Values.Any())
            return 0;
        
        return VFS.Index.Values.Max(n => n.Path.Depth);
    }

    private IEnumerable<IGrouping<string, IFileNode>> GetFileExtensions()
    {
        return VFS.Files
            .GroupBy(f => Path.GetExtension(f.Name).ToLowerInvariant())
            .OrderByDescending(g => g.Count());
    }

    private long GetDirectorySize(IDirectoryNode directory)
    {
        return directory.Files.Sum(f => (long)f.Content.Length);
    }

    private void SelectFile(IFileNode file)
    {
        StateService.SelectedNode = file;
    }

    private void SelectDirectory(IDirectoryNode directory)
    {
        StateService.SelectedNode = directory;
    }

    private void RefreshAnalytics()
    {
        StateHasChanged();
    }

    public void Dispose()
    {
        StateService.OnDataChanged -= StateHasChanged;
    }
}