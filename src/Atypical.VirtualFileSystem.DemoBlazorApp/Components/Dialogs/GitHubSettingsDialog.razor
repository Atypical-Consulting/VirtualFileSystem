@* GitHub Settings Dialog - PAT Authentication *@
@inject GitHubAuthService AuthService
@inject ToastService Toast
@implements IDisposable

<Modal @bind-IsOpen="IsOpen" Title="GitHub Settings" Size="md" CloseOnBackdropClick="@(!_isValidating)">
    <ChildContent>
        <div class="space-y-5">
            @* Authentication Status *@
            <div class="@(_getStatusBgClass()) rounded-lg p-4">
                <div class="flex gap-3">
                    @if (AuthService.IsAuthenticated)
                    {
                        <svg class="w-5 h-5 text-green-500 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                        </svg>
                        <div class="flex-1">
                            <h4 class="text-sm font-medium text-green-800">Authenticated</h4>
                            <p class="text-sm text-green-700 mt-0.5">
                                Signed in as <span class="font-semibold">@AuthService.CurrentCredentials.Username</span>
                            </p>
                        </div>
                    }
                    else
                    {
                        <svg class="w-5 h-5 text-gray-400 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 5.25a3 3 0 0 1 3 3m3 0a6 6 0 0 1-7.029 5.912c-.563-.097-1.159.026-1.563.43L10.5 17.25H8.25v2.25H6v2.25H2.25v-2.818c0-.597.237-1.17.659-1.591l6.499-6.499c.404-.404.527-1 .43-1.563A6 6 0 1 1 21.75 8.25Z" />
                        </svg>
                        <div class="flex-1">
                            <h4 class="text-sm font-medium text-gray-700">Anonymous</h4>
                            <p class="text-sm text-gray-500 mt-0.5">
                                Using anonymous access (60 requests/hour)
                            </p>
                        </div>
                    }
                </div>
            </div>

            @* Rate Limit Info *@
            <div class="bg-gray-50 rounded-lg p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <h4 class="text-sm font-medium text-gray-700">API Rate Limit</h4>
                        <p class="text-sm text-gray-500">
                            @AuthService.CurrentCredentials.RateLimitDisplay requests
                            @if (AuthService.CurrentCredentials.TimeUntilReset is not null)
                            {
                                <span class="text-gray-400">
                                    (resets in @AuthService.CurrentCredentials.TimeUntilReset)
                                </span>
                            }
                        </p>
                    </div>
                    <button type="button"
                            class="text-gray-400 hover:text-gray-600 p-1"
                            @onclick="RefreshRateLimits"
                            disabled="@_isRefreshingRateLimit"
                            title="Refresh rate limits">
                        <svg class="w-4 h-4 @(_isRefreshingRateLimit ? "animate-spin" : "")" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99" />
                        </svg>
                    </button>
                </div>
                @* Rate Limit Progress Bar *@
                <div class="mt-2">
                    @{
                        var percentage = AuthService.CurrentCredentials.RateLimitTotal > 0
                            ? (int)((double)AuthService.CurrentCredentials.RateLimitRemaining / AuthService.CurrentCredentials.RateLimitTotal * 100)
                            : 0;
                        var barClass = percentage > 50 ? "bg-green-500" : percentage > 20 ? "bg-yellow-500" : "bg-red-500";
                    }
                    <div class="w-full bg-gray-200 rounded-full h-1.5">
                        <div class="@barClass h-1.5 rounded-full transition-all duration-300" style="width: @percentage%"></div>
                    </div>
                </div>
            </div>

            <hr class="border-gray-200" />

            @* PAT Input Section *@
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                    Personal Access Token (PAT)
                </label>
                <div class="relative">
                    <input type="@(_showToken ? "text" : "password")"
                           class="input pr-10"
                           placeholder="ghp_xxxxxxxxxxxxxxxxxxxx"
                           @bind="_tokenInput"
                           @bind:event="oninput"
                           disabled="@_isValidating" />
                    <button type="button"
                            class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-400 hover:text-gray-600"
                            @onclick="() => _showToken = !_showToken">
                        @if (_showToken)
                        {
                            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 0 0 1.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.451 10.451 0 0 1 12 4.5c4.756 0 8.773 3.162 10.065 7.498a10.522 10.522 0 0 1-4.293 5.774M6.228 6.228 3 3m3.228 3.228 3.65 3.65m7.894 7.894L21 21m-3.228-3.228-3.65-3.65m0 0a3 3 0 1 0-4.243-4.243m4.242 4.242L9.88 9.88" />
                            </svg>
                        }
                        else
                        {
                            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 0 1 0-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178Z" />
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                            </svg>
                        }
                    </button>
                </div>
                <p class="text-xs text-gray-500 mt-1">
                    <a href="https://github.com/settings/tokens/new?description=CloudDrive%20VFS&scopes=repo"
                       target="_blank"
                       rel="noopener noreferrer"
                       class="text-cloud-600 hover:text-cloud-700 hover:underline">
                        Create a new token
                    </a>
                    with <code class="bg-gray-100 px-1 rounded">repo</code> scope
                </p>
            </div>

            @* Error Message *@
            @if (!string.IsNullOrEmpty(_errorMessage))
            {
                <div class="bg-red-50 border border-red-200 rounded-lg p-3">
                    <div class="flex gap-2">
                        <svg class="w-4 h-4 text-red-500 flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 3.75h.008v.008H12v-.008Z" />
                        </svg>
                        <p class="text-sm text-red-700">@_errorMessage</p>
                    </div>
                </div>
            }

            @* Security Warning *@
            <div class="bg-amber-50 border border-amber-200 rounded-lg p-3">
                <div class="flex gap-2">
                    <svg class="w-4 h-4 text-amber-500 flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" />
                    </svg>
                    <div class="text-sm text-amber-700">
                        <span class="font-medium">Security Notice:</span> Your token will be stored in browser localStorage.
                        Only use this on trusted devices.
                    </div>
                </div>
            </div>
        </div>
    </ChildContent>
    <Footer>
        @if (AuthService.IsAuthenticated)
        {
            <Button Variant="danger" OnClick="ClearCredentials" Disabled="@_isValidating">
                Sign Out
            </Button>
            <div class="flex-1"></div>
            <Button Variant="ghost" OnClick="Close">Close</Button>
        }
        else
        {
            <Button Variant="ghost" OnClick="Close" Disabled="@_isValidating">Cancel</Button>
            <Button Variant="primary"
                    OnClick="ValidateToken"
                    Disabled="@(!CanValidate || _isValidating)"
                    Icon="@(_isValidating ? "" : "M9 12.75 11.25 15 15 9.75m-3-7.036A11.959 11.959 0 0 1 3.598 6 11.99 11.99 0 0 0 3 9.749c0 5.592 3.824 10.29 9 11.623 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.571-.598-3.751h-.152c-3.196 0-6.1-1.248-8.25-3.285Z")">
                @if (_isValidating)
                {
                    <span class="flex items-center gap-2">
                        <svg class="animate-spin h-4 w-4" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Validating...
                    </span>
                }
                else
                {
                    <span>Authenticate</span>
                }
            </Button>
        }
    </Footer>
</Modal>

@code {
    [Parameter] public bool IsOpen { get; set; }
    [Parameter] public EventCallback<bool> IsOpenChanged { get; set; }

    private string _tokenInput = "";
    private bool _showToken = false;
    private bool _isValidating = false;
    private bool _isRefreshingRateLimit = false;
    private string? _errorMessage;

    private bool CanValidate => !string.IsNullOrWhiteSpace(_tokenInput) && _tokenInput.Length >= 10;

    protected override async Task OnInitializedAsync()
    {
        AuthService.OnCredentialsChanged += StateHasChanged;
        AuthService.OnRateLimitUpdated += StateHasChanged;
        await AuthService.InitializeAsync();
    }

    private string _getStatusBgClass()
    {
        return AuthService.IsAuthenticated ? "bg-green-50 border border-green-200" : "bg-gray-100";
    }

    private async Task ValidateToken()
    {
        if (!CanValidate) return;

        _isValidating = true;
        _errorMessage = null;
        StateHasChanged();

        try
        {
            var (success, errorMessage) = await AuthService.ValidateTokenAsync(_tokenInput);

            if (success)
            {
                Toast.ShowSuccess($"Authenticated as {AuthService.CurrentCredentials.Username}");
                _tokenInput = "";
            }
            else
            {
                _errorMessage = errorMessage;
            }
        }
        finally
        {
            _isValidating = false;
            StateHasChanged();
        }
    }

    private async Task ClearCredentials()
    {
        await AuthService.ClearCredentialsAsync();
        Toast.ShowInfo("Signed out from GitHub");
        _tokenInput = "";
        _errorMessage = null;
    }

    private async Task RefreshRateLimits()
    {
        _isRefreshingRateLimit = true;
        StateHasChanged();

        try
        {
            await AuthService.RefreshRateLimitsAsync();
        }
        finally
        {
            _isRefreshingRateLimit = false;
            StateHasChanged();
        }
    }

    private async Task Close()
    {
        _tokenInput = "";
        _showToken = false;
        _errorMessage = null;
        await IsOpenChanged.InvokeAsync(false);
    }

    public void Dispose()
    {
        AuthService.OnCredentialsChanged -= StateHasChanged;
        AuthService.OnRateLimitUpdated -= StateHasChanged;
    }
}
