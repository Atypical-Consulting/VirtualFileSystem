@inject IVirtualFileSystem VFS
@inject ISnackbar Snackbar
@rendermode InteractiveServer

<MudStack Spacing="2">
    <MudText Typo="Typo.body2" Class="mb-2">
        Undo Stack: @VFS.ChangeHistory.UndoStack.Count | Redo Stack: @VFS.ChangeHistory.RedoStack.Count
    </MudText>
    
    <MudStack Row="true" Spacing="2">
        <MudButton Variant="Variant.Filled" 
                   Color="Color.Secondary" 
                   StartIcon="@Icons.Material.Filled.Undo"
                   OnClick="Undo"
                   Disabled="!VFS.ChangeHistory.UndoStack.Any()"
                   Size="Size.Small">
            Undo
        </MudButton>
        
        <MudButton Variant="Variant.Filled" 
                   Color="Color.Secondary" 
                   StartIcon="@Icons.Material.Filled.Redo"
                   OnClick="Redo"
                   Disabled="!VFS.ChangeHistory.RedoStack.Any()"
                   Size="Size.Small">
            Redo
        </MudButton>
    </MudStack>

    @if (VFS.ChangeHistory.UndoStack.Any())
    {
        <MudCollapse Expanded="ShowUndoStack">
            <MudPaper Class="pa-2" Elevation="1">
                <MudText Typo="Typo.caption" Class="mb-1">Recent Operations:</MudText>
                @foreach (var operation in VFS.ChangeHistory.UndoStack.Take(5).Reverse())
                {
                    <MudChip T="string" Size="Size.Small" Variant="Variant.Text" Class="ma-1">
                        @GetOperationDescription(operation)
                    </MudChip>
                }
            </MudPaper>
        </MudCollapse>
        
        <MudButton Variant="Variant.Text" 
                   Size="Size.Small"
                   OnClick="() => ShowUndoStack = !ShowUndoStack">
            @(ShowUndoStack ? "Hide" : "Show") History
        </MudButton>
    }
</MudStack>

@code {
    [Parameter] public EventCallback OnHistoryChanged { get; set; }
    
    private bool ShowUndoStack = false;

    private async Task Undo()
    {
        try
        {
            if (VFS.ChangeHistory.UndoStack.Any())
            {
                VFS.ChangeHistory.Undo();
                Snackbar.Add("Operation undone successfully!", Severity.Info);
                await OnHistoryChanged.InvokeAsync();
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error during undo: {ex.Message}", Severity.Error);
        }
    }

    private async Task Redo()
    {
        try
        {
            if (VFS.ChangeHistory.RedoStack.Any())
            {
                VFS.ChangeHistory.Redo();
                Snackbar.Add("Operation redone successfully!", Severity.Success);
                await OnHistoryChanged.InvokeAsync();
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error during redo: {ex.Message}", Severity.Error);
        }
    }

    private string GetOperationDescription(VFSEventArgs eventArgs)
    {
        return eventArgs switch
        {
            VFSFileCreatedArgs fileCreated => $"Created file: {Path.GetFileName(fileCreated.Path.Value)}",
            VFSDirectoryCreatedArgs dirCreated => $"Created directory: {Path.GetFileName(dirCreated.Path.Value)}",
            VFSFileDeletedArgs fileDeleted => $"Deleted file: {Path.GetFileName(fileDeleted.Path.Value)}",
            VFSDirectoryDeletedArgs dirDeleted => $"Deleted directory: {Path.GetFileName(dirDeleted.Path.Value)}",
            VFSFileMovedArgs fileMoved => $"Moved file: {Path.GetFileName(fileMoved.SourcePath.Value)}",
            VFSDirectoryMovedArgs dirMoved => $"Moved directory: {Path.GetFileName(dirMoved.SourcePath.Value)}",
            VFSFileRenamedArgs fileRenamed => $"Renamed file: {fileRenamed.OldName} → {fileRenamed.NewName}",
            VFSDirectoryRenamedArgs dirRenamed => $"Renamed directory: {dirRenamed.OldName} → {dirRenamed.NewName}",
            _ => "Unknown operation"
        };
    }
}